<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Keep (Local Path Guide)</title>
    <!-- Google Material Icons & Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&family=Google+Sans:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <!-- SheetJS for Excel Processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* --- CSS Reset & Variables --- */
        :root {
            --bg-body: #ffffff;
            --bg-sidebar: #ffffff;
            --bg-header: #ffffff;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --border-color: #e0e0e0;
            --hover-bg: #f1f3f4;
            --accent-color: #feefc3;
            --shadow-1: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --shadow-2: 0 4px 6px rgba(60,64,67,0.3);
            --header-height: 64px;
            --sidebar-width: 280px;
            --sidebar-mini-width: 80px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* --- Utility Classes --- */
        .icon-btn {
            background: none; border: none; cursor: pointer;
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary); transition: background 0.2s;
            position: relative;
            margin-right: 4px;
        }
        .icon-btn:hover { background-color: rgba(60,64,67,0.08); color: #202124; }
        .material-symbols-outlined { font-size: 20px; }
        
        .icon-btn[title]:hover::after {
            content: attr(title);
            position: absolute; top: 110%; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 4px 8px;
            border-radius: 4px; font-size: 11px; white-space: nowrap;
            z-index: 2000; pointer-events: none;
        }

        /* --- Header --- */
        header {
            position: fixed; top: 0; width: 100%; height: var(--header-height);
            background: var(--bg-header); border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; padding: 0 12px; z-index: 1000;
            justify-content: space-between;
        }
        .header-start { display: flex; align-items: center; min-width: 230px; }
        .logo-area { display: flex; align-items: center; margin-left: 4px; cursor: pointer; }
        .logo-img { height: 40px; width: 40px; }
        .logo-text { font-family: 'Google Sans', sans-serif; font-size: 22px; color: var(--text-secondary); margin-left: 4px; }
        .header-center { flex: 1; max-width: 720px; margin: 0 20px; }
        .search-bar {
            background: #f1f3f4; border-radius: 8px; height: 48px;
            display: flex; align-items: center; padding: 0 8px;
            transition: background 0.2s, box-shadow 0.2s;
        }
        .search-bar:focus-within { background: #fff; box-shadow: 0 1px 1px 0 rgba(65,69,73,0.3), 0 1px 3px 1px rgba(65,69,73,0.15); }
        .search-bar input { flex: 1; background: transparent; border: none; height: 100%; font-size: 16px; padding: 0 8px; }
        .header-end { display: flex; align-items: center; min-width: 100px; justify-content: flex-end; }
        .avatar {
            width: 32px; height: 32px; background: #a142f4; color: #fff;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 500; margin-left: 12px; margin-right: 12px; cursor: pointer;
        }

        /* --- Layout --- */
        .app-container { display: flex; margin-top: var(--header-height); min-height: calc(100vh - var(--header-height)); }

        /* --- Sidebar --- */
        .sidebar {
            width: var(--sidebar-width); padding-top: 8px;
            position: fixed; height: 100%; overflow-y: auto;
            background: var(--bg-sidebar); transition: width 0.3s ease;
            z-index: 900;
        }
        .sidebar.mini { width: var(--sidebar-mini-width); }
        .sidebar.mini .nav-text { display: none; }
        .sidebar.mini .nav-item { border-radius: 50%; width: 48px; height: 48px; padding: 0; justify-content: center; margin-left: 12px; }
        .sidebar.mini .nav-item .material-symbols-outlined { margin: 0; }
        .nav-item {
            display: flex; align-items: center; padding: 12px 24px;
            cursor: pointer; border-radius: 0 25px 25px 0; margin-right: 12px;
            color: var(--text-primary); text-decoration: none;
        }
        .nav-item:hover { background-color: var(--hover-bg); }
        .nav-item.active { background-color: var(--accent-color); }
        .nav-item .material-symbols-outlined { margin-right: 20px; color: var(--text-secondary); }
        .nav-text { font-weight: 500; font-size: 14px; letter-spacing: .25px; }

        /* --- Main Content --- */
        main {
            flex: 1; margin-left: var(--sidebar-width); padding: 32px;
            transition: margin-left 0.3s ease;
            display: flex; flex-direction: column; align-items: center;
        }
        .sidebar.mini + main { margin-left: var(--sidebar-mini-width); }

        /* --- Create Note Area --- */
        .create-note-container { width: 100%; max-width: 600px; margin-bottom: 30px; position: relative; }
        .create-note-card {
            background: #fff; border-radius: 8px;
            box-shadow: var(--shadow-1); padding: 12px 16px;
            transition: box-shadow 0.2s, background-color 0.2s; border: 1px solid #e0e0e0;
            position: relative; overflow: hidden;
        }
        .create-note-card.expanded { box-shadow: var(--shadow-2); }
        
        #create-image-preview {
            width: 100%; max-height: 300px; object-fit: cover;
            border-radius: 4px; margin-bottom: 12px; display: none;
        }
        #create-image-preview.show { display: block; }

        .create-note-card input, .create-note-card textarea {
            width: 100%; border: none; resize: none; font-family: 'Roboto', sans-serif;
            background: transparent;
        }
        #title-input { font-size: 16px; font-weight: 500; margin-bottom: 12px; display: none; padding-top: 4px; }
        #content-input { font-size: 14px; line-height: 1.5rem; height: 24px; overflow: hidden; }
        #content-input::placeholder { font-weight: 500; color: #5f6368; }

        #create-labels-container { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; display: none; }
        #create-labels-container.show { display: flex; }

        .create-actions { display: none; justify-content: space-between; align-items: center; margin-top: 12px; }
        .close-btn {
            background: transparent; border: none; font-weight: 500; font-size: 14px;
            padding: 8px 24px; cursor: pointer; border-radius: 4px;
        }
        .close-btn:hover { background-color: rgba(0,0,0,0.05); }

        /* --- Notes Grid (Masonry) --- */
        .notes-section { width: 100%; max-width: 1200px; margin-bottom: 40px; }
        .section-label { font-size: 11px; font-weight: 500; letter-spacing: 0.8px; color: #5f6368; text-transform: uppercase; margin: 0 0 8px 16px; }
        .notes-grid { column-count: 4; column-gap: 16px; margin: 0 auto; }

        .note-card {
            background-color: #fff; border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 12px; margin-bottom: 16px;
            break-inside: avoid; position: relative;
            transition: box-shadow 0.2s; cursor: default;
        }
        .note-card:hover { box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15); }
        .note-card:hover .note-tools, .note-card:hover .pin-icon { opacity: 1; }
        
        .note-img { width: calc(100% + 24px); margin: -12px -12px 8px -12px; display: block; max-height: 300px; object-fit: cover; border-radius: 8px 8px 0 0; }
        .note-title { font-weight: 500; font-size: 16px; margin-bottom: 8px; line-height: 1.5; }
        .note-content { font-size: 14px; line-height: 1.4; color: var(--text-primary); white-space: pre-wrap; }
        
        .note-labels { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 12px; }
        .chip {
            background: rgba(0,0,0,0.08); padding: 4px 8px; border-radius: 4px;
            font-size: 11px; color: var(--text-secondary); display: flex; align-items: center;
        }
        .chip .remove-label { margin-left: 4px; cursor: pointer; font-size: 14px; opacity: 0.6; }
        .chip .remove-label:hover { opacity: 1; }

        .pin-icon {
            position: absolute; top: 8px; right: 8px; opacity: 0;
            cursor: pointer; padding: 8px; border-radius: 50%;
            background: rgba(255,255,255,0.6); transition: 0.2s; z-index: 10;
        }
        .pin-icon:hover { background: rgba(0,0,0,0.1); color: #000; }
        .pin-icon.pinned { opacity: 1; color: var(--text-primary); }

        .note-tools {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 12px; height: 32px; opacity: 0; transition: opacity 0.2s;
        }

        /* --- Menus & Popups --- */
        .popup-menu {
            position: absolute; background: white; box-shadow: var(--shadow-2);
            border-radius: 4px; padding: 6px 0; z-index: 1000; min-width: 150px;
        }
        .popup-item {
            padding: 8px 16px; font-size: 14px; cursor: pointer; color: var(--text-primary);
        }
        .popup-item:hover { background-color: #f1f3f4; }
        
        .color-palette {
            position: absolute; background: white; box-shadow: var(--shadow-2);
            padding: 8px; border-radius: 8px; display: flex; gap: 6px; z-index: 1100;
            flex-wrap: wrap; width: 140px;
        }
        .color-circle {
            width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 1px solid #ddd;
        }
        .color-circle:hover { border-color: #555; transform: scale(1.1); }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(32,33,36,0.6); z-index: 2000;
            display: flex; justify-content: center; align-items: center; opacity: 0;
            pointer-events: none; transition: opacity 0.2s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal {
            background: #fff; width: 600px; max-width: 90%;
            border-radius: 8px; padding: 16px; box-shadow: var(--shadow-2);
            display: flex; flex-direction: column; position: relative;
        }
        .modal-img { max-height: 300px; object-fit: contain; margin-bottom: 12px; border-radius: 4px; }
        .modal input { font-size: 20px; margin-bottom: 12px; font-weight: 500; border: none; width: 100%; background: transparent; }
        .modal textarea { font-size: 14px; min-height: 200px; border: none; width: 100%; resize: none; line-height: 1.5; background: transparent; }
        .modal-footer { display: flex; justify-content: flex-end; margin-top: 16px; }

        /* --- Responsive --- */
        @media (max-width: 1100px) { .notes-grid { column-count: 3; } }
        @media (max-width: 800px) {
            .notes-grid { column-count: 2; }
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); width: 280px; box-shadow: var(--shadow-2); }
            main { margin-left: 0 !important; }
            .logo-text { display: none; }
        }
        @media (max-width: 500px) {
            .notes-grid { column-count: 1; }
            .search-bar, .header-end { display: none; }
        }
    </style>
</head>
<body>

    <!-- Hidden Inputs -->
    <input type="file" id="excel-file-input" accept=".xlsx, .xls" style="display: none;">
    <input type="file" id="image-file-input" accept="image/*" style="display: none;">

    <header>
        <div class="header-start">
            <button class="icon-btn" id="menu-btn"><span class="material-symbols-outlined">menu</span></button>
            <div class="logo-area" onclick="location.reload()">
                <img src="https://www.gstatic.com/images/branding/product/1x/keep_2020q4_48dp.png" alt="Keep Logo" class="logo-img">
                <span class="logo-text">Keep</span>
            </div>
        </div>
        <div class="header-center">
            <div class="search-bar">
                <span class="material-symbols-outlined" style="color:#5f6368; margin-right:8px;">search</span>
                <input type="text" id="search-input" placeholder="검색">
            </div>
        </div>
        <div class="header-end">
            <button class="icon-btn" onclick="triggerImport()" title="Excel 열기"><span class="material-symbols-outlined">upload_file</span></button>
            <button class="icon-btn" onclick="exportExcel()" title="Excel 저장"><span class="material-symbols-outlined">save_alt</span></button>
            <button class="icon-btn"><span class="material-symbols-outlined">settings</span></button>
            <div class="avatar">U</div>
        </div>
    </header>

    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <a href="#" class="nav-item active" onclick="filterNotes('all')"><span class="material-symbols-outlined">lightbulb</span><span class="nav-text">메모</span></a>
            <a href="#" class="nav-item"><span class="material-symbols-outlined">notifications</span><span class="nav-text">알림</span></a>
            <a href="#" class="nav-item"><span class="material-symbols-outlined">edit</span><span class="nav-text">라벨 수정</span></a>
            <a href="#" class="nav-item"><span class="material-symbols-outlined">archive</span><span class="nav-text">보관처리</span></a>
            <a href="#" class="nav-item"><span class="material-symbols-outlined">delete</span><span class="nav-text">휴지통</span></a>
        </nav>

        <!-- Main Content -->
        <main>
            <!-- Create Note Area -->
            <div class="create-note-container">
                <div class="create-note-card" id="create-area">
                    <!-- Image Preview -->
                    <img id="create-image-preview" src="" alt="Preview">
                    
                    <!-- Text Inputs -->
                    <input type="text" id="title-input" placeholder="제목">
                    <textarea id="content-input" placeholder="메모 작성..." rows="1"></textarea>
                    
                    <!-- Labels -->
                    <div id="create-labels-container"></div>

                    <!-- Actions Toolbar --> 
                    <div class="create-actions" id="create-actions">
                        <div style="display:flex;">
                            <button class="icon-btn" title="알림 (데모)"><span class="material-symbols-outlined">add_alert</span></button>
                            <button class="icon-btn" id="btn-create-palette" title="배경색"><span class="material-symbols-outlined">palette</span></button>
                            <button class="icon-btn" id="btn-create-image" title="이미지 추가"><span class="material-symbols-outlined">image</span></button>
                            <button class="icon-btn" id="btn-create-archive" title="보관 (데모)"><span class="material-symbols-outlined">archive</span></button>
                            <button class="icon-btn" id="btn-create-more" title="더보기 (라벨)"><span class="material-symbols-outlined">more_vert</span></button>
                        </div>
                        <button class="close-btn" id="close-create">닫기</button>
                    </div>
                </div>
            </div>

            <!-- Notes List -->
            <div class="notes-section" id="pinned-section">
                <div class="section-label">고정됨</div>
                <div class="notes-grid" id="pinned-notes"></div>
            </div>
            
            <div class="notes-section" id="others-section">
                <div class="section-label" id="others-label">기타</div>
                <div class="notes-grid" id="other-notes"></div>
            </div>
        </main>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal" id="modal-card">
            <img id="modal-img" class="modal-img" style="display:none;">
            <input type="text" id="modal-title" placeholder="제목">
            <textarea id="modal-content" placeholder="메모 내용"></textarea>
            <div id="modal-labels" class="note-labels"></div>
            <div class="modal-footer">
                <button class="close-btn" id="modal-close-btn">닫기</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Global State ---
        const colors = ['#FFFFFF', '#F28B82', '#FBBC04', '#FFF475', '#CCFF90', '#A7FFEB', '#CBF0F8', '#AECBFA', '#D7AEFB', '#E6C9A8', '#E8EAED'];
        let notes = [];
        let globalWorkbook = null;
        
        // [User Request] The path user wants to use. 
        // Note: Browsers block absolute path fetch. This variable is for the error message guide.
        const TARGET_PATH = 'myhome/keep';

        // Draft Note State
        let draftNote = { color: '#FFFFFF', image: null, labels: [] };

        // --- 2. Initialization: Strict File Load ---
        async function initData() {
            try {
                // Attempt to fetch keepdata.xlsx from the same directory (Relative Path)
                // The browser security model (Sandbox) strictly prevents accessing 'C:\...' directly.
                // Therefore, the file MUST be in the same directory as index.html and served via a Web Server.
                console.log(`Attempting to load data... (Target: ${TARGET_PATH})`);
                
                // Using relative path './keepdata.xlsx' is the only web-standard way to load adjacent files.
                const response = await fetch('keepdata.xlsx');
                
                if (!response.ok) {
                    throw new Error(`Fetch failed with status ${response.status}`);
                }

                const arrayBuffer = await response.arrayBuffer();
                loadWorkbook(arrayBuffer);
                console.log("Success: Loaded keepdata.xlsx from local server directory.");

            } catch (error) {
                console.warn("Auto-load failed.", error);
                
                // [User Request] Alert with path information
                alert(`Data File Not Found.\n\n앱이 다음 경로에서 파일을 찾지 못했습니다:\n${TARGET_PATH}\n\n[해결 방법]\n1. 'index.html' 파일을 'keepdata.xlsx'와 같은 폴더에 넣어주세요.\n2. 브라우저 보안 정책상 HTML 파일을 직접 실행하면 안 됩니다.\n3. 'Live Server'나 로컬 웹 서버를 통해 실행해 주세요.`);
            }
        }

        // --- 3. SheetJS Logic ---
        function loadWorkbook(buf, wbObj = null) {
            const wb = wbObj || XLSX.read(buf, {type: 'array', cellDates: true});
            globalWorkbook = wb;
            
            const sheetName = wb.SheetNames[0];
            const sheet = wb.Sheets[sheetName];
            
            // raw: false ensures we get formatted strings (e.g. "2025. 12. 9...")
            const json = XLSX.utils.sheet_to_json(sheet, {raw: false});
            
            notes = json.map(r => ({
                id: parseInt(r.id) || getNextId(),
                title: r.title || '',
                content: r.content || '',
                created_at: r.created_at || new Date().toLocaleString(),
                updated_at: r.updated_at || new Date().toLocaleString(),
                color: r.color || '#FFFFFF',
                is_pinned: String(r.is_pinned).toUpperCase() === 'TRUE',
                labels: r.labels ? String(r.labels).split(',').map(s => s.trim()) : [],
                image: r.image || null
            }));
            renderNotes();
        }

        function exportExcel() {
            if(!globalWorkbook) globalWorkbook = XLSX.utils.book_new();
            
            // Sort by ID
            const sorted = [...notes].sort((a,b) => a.id - b.id);
            
            const data = sorted.map(n => ({
                id: n.id,
                title: n.title,
                content: n.content,
                created_at: n.created_at,
                updated_at: n.updated_at,
                color: n.color,
                is_pinned: n.is_pinned ? 'TRUE' : 'FALSE',
                labels: n.labels.join(', '),
                image: n.image
            }));
            
            const sheet = XLSX.utils.json_to_sheet(data);
            const name = globalWorkbook.SheetNames[0] || "Sheet1";
            
            // Update or Append Sheet
            globalWorkbook.Sheets[name] = sheet;
            if(!globalWorkbook.SheetNames.includes(name)) {
                XLSX.utils.book_append_sheet(globalWorkbook, sheet, name);
            }
            
            // Note: Browser will save to default Downloads folder or ask user.
            XLSX.writeFile(globalWorkbook, 'keepdata.xlsx');
        }

        function triggerImport() { document.getElementById('excel-file-input').click(); }
        document.getElementById('excel-file-input').onchange = (e) => {
            const f = e.target.files[0];
            if(f) {
                const r = new FileReader();
                r.onload = (e) => loadWorkbook(new Uint8Array(e.target.result));
                r.readAsArrayBuffer(f);
            }
        };

        // --- 4. UI Actions (Palette, Image, Labels) ---
        
        // Palette
        document.getElementById('btn-create-palette').addEventListener('click', (e) => {
            e.stopPropagation();
            showPalette(e.target, (c) => {
                draftNote.color = c;
                document.getElementById('create-area').style.backgroundColor = c;
            });
        });

        // Image
        document.getElementById('btn-create-image').addEventListener('click', (e) => {
            e.stopPropagation();
            const input = document.getElementById('image-file-input');
            input.onchange = (evt) => {
                const file = evt.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (r) => {
                        draftNote.image = r.target.result;
                        const preview = document.getElementById('create-image-preview');
                        preview.src = draftNote.image;
                        preview.classList.add('show');
                        expandCreateArea();
                    };
                    reader.readAsDataURL(file);
                }
                input.value = '';
            };
            input.click();
        });

        // Labels
        document.getElementById('btn-create-more').addEventListener('click', (e) => {
            e.stopPropagation();
            showMenu(e.target, [
                { text: '라벨 추가', action: () => promptLabelInput() }
            ]);
        });

        function promptLabelInput() {
            const label = prompt("라벨 이름을 입력하세요:");
            if (label && label.trim() !== "") {
                if (!draftNote.labels.includes(label)) {
                    draftNote.labels.push(label);
                    renderDraftLabels();
                }
            }
        }

        function renderDraftLabels() {
            const container = document.getElementById('create-labels-container');
            container.innerHTML = '';
            if (draftNote.labels.length > 0) {
                container.classList.add('show');
                draftNote.labels.forEach(lbl => {
                    const chip = document.createElement('div');
                    chip.className = 'chip';
                    chip.innerHTML = `${lbl} <span class="remove-label" onclick="removeDraftLabel('${lbl}')">&times;</span>`;
                    container.appendChild(chip);
                });
            } else {
                container.classList.remove('show');
            }
        }
        
        window.removeDraftLabel = function(lbl) {
            draftNote.labels = draftNote.labels.filter(l => l !== lbl);
            renderDraftLabels();
        };

        // --- 5. Create & Render Notes ---
        const createArea = document.getElementById('create-area');
        const titleInput = document.getElementById('title-input');
        const contentInput = document.getElementById('content-input');
        const createActions = document.getElementById('create-actions');

        function expandCreateArea() {
            createArea.classList.add('expanded');
            titleInput.style.display = 'block';
            createActions.style.display = 'flex';
            contentInput.rows = 3;
        }

        function collapseCreateArea() {
            createArea.classList.remove('expanded');
            titleInput.style.display = 'none';
            createActions.style.display = 'none';
            contentInput.rows = 1;
        }

        contentInput.addEventListener('focus', expandCreateArea);

        document.getElementById('close-create').addEventListener('click', () => {
            const title = titleInput.value.trim();
            const content = contentInput.value.trim();
            
            if (title || content || draftNote.image) {
                const now = new Date();
                const dateStr = now.toLocaleString(); // Use local format
                
                notes.unshift({
                    id: getNextId(),
                    title: title,
                    content: content,
                    created_at: dateStr,
                    updated_at: dateStr,
                    color: draftNote.color,
                    is_pinned: false,
                    labels: [...draftNote.labels],
                    image: draftNote.image
                });
                renderNotes();
            }
            resetDraft();
            collapseCreateArea();
        });

        function resetDraft() {
            titleInput.value = '';
            contentInput.value = '';
            draftNote = { color: '#FFFFFF', image: null, labels: [] };
            createArea.style.backgroundColor = '#FFFFFF';
            document.getElementById('create-image-preview').src = '';
            document.getElementById('create-image-preview').classList.remove('show');
            renderDraftLabels();
        }

        function renderNotes(filtered = null) {
            const list = filtered || notes;
            const pinnedContainer = document.getElementById('pinned-notes');
            const otherContainer = document.getElementById('other-notes');
            
            pinnedContainer.innerHTML = '';
            otherContainer.innerHTML = '';

            const pinned = list.filter(n => n.is_pinned);
            const others = list.filter(n => !n.is_pinned);

            document.getElementById('pinned-section').style.display = pinned.length ? 'block' : 'none';
            document.getElementById('others-label').style.display = pinned.length ? 'block' : 'none';

            pinned.forEach(n => pinnedContainer.appendChild(createCard(n)));
            others.forEach(n => otherContainer.appendChild(createCard(n)));
        }

        function createCard(note) {
            const el = document.createElement('div');
            el.className = 'note-card';
            el.style.backgroundColor = note.color;
            el.dataset.id = note.id;

            const pinBtn = document.createElement('div');
            pinBtn.className = `pin-icon material-symbols-outlined ${note.is_pinned ? 'pinned' : ''}`;
            pinBtn.innerText = 'keep';
            pinBtn.onclick = (e) => { e.stopPropagation(); togglePin(note.id); };
            el.appendChild(pinBtn);

            if(note.image) {
                const img = document.createElement('img');
                img.src = note.image;
                img.className = 'note-img';
                el.appendChild(img);
            }

            el.innerHTML += `
                <div class="note-title" style="${!note.title ? 'display:none' : ''}">${note.title}</div>
                <div class="note-content">${note.content}</div>
            `;

            if(note.labels && note.labels.length > 0) {
                const labelsDiv = document.createElement('div');
                labelsDiv.className = 'note-labels';
                note.labels.forEach(l => {
                    labelsDiv.innerHTML += `<span class="chip">${l}</span>`;
                });
                el.appendChild(labelsDiv);
            }

            const toolbar = document.createElement('div');
            toolbar.className = 'note-tools';
            toolbar.innerHTML = `
                <button class="icon-btn" onclick="event.stopPropagation(); showCardPalette(event, ${note.id})"><span class="material-symbols-outlined">palette</span></button>
                <button class="icon-btn" onclick="event.stopPropagation(); deleteNote(${note.id})"><span class="material-symbols-outlined">delete</span></button>
                <button class="icon-btn" onclick="event.stopPropagation(); showCardMenu(event, ${note.id})"><span class="material-symbols-outlined">more_vert</span></button>
            `;
            el.appendChild(toolbar);

            el.onclick = () => openEditModal(note);
            return el;
        }

        // --- 6. Helpers & Menus ---
        function getNextId() {
            return notes.length ? Math.max(...notes.map(n => parseInt(n.id)||0)) + 1 : 1;
        }
        function togglePin(id) {
            const n = notes.find(x => x.id === id);
            if(n) { n.is_pinned = !n.is_pinned; renderNotes(); }
        }
        function deleteNote(id) {
            if(confirm('삭제하시겠습니까?')) {
                notes = notes.filter(n => n.id !== id);
                renderNotes();
            }
        }
        document.getElementById('search-input').oninput = (e) => {
            const term = e.target.value.toLowerCase();
            renderNotes(notes.filter(n => (n.title+n.content).toLowerCase().includes(term)));
        };

        function showPalette(target, callback) {
            document.querySelectorAll('.color-palette, .popup-menu').forEach(e => e.remove());
            const p = document.createElement('div');
            p.className = 'color-palette';
            colors.forEach(c => {
                const d = document.createElement('div');
                d.className = 'color-circle';
                d.style.backgroundColor = c;
                d.onclick = (e) => { e.stopPropagation(); callback(c); p.remove(); };
                p.appendChild(d);
            });
            positionPopup(p, target);
        }

        function showMenu(target, items) {
            document.querySelectorAll('.color-palette, .popup-menu').forEach(e => e.remove());
            const m = document.createElement('div');
            m.className = 'popup-menu';
            items.forEach(item => {
                const d = document.createElement('div');
                d.className = 'popup-item';
                d.innerText = item.text;
                d.onclick = (e) => { e.stopPropagation(); item.action(); m.remove(); };
                m.appendChild(d);
            });
            positionPopup(m, target);
        }

        function positionPopup(el, target) {
            document.body.appendChild(el);
            const rect = target.getBoundingClientRect();
            el.style.top = (rect.bottom + window.scrollY) + 'px';
            el.style.left = rect.left + 'px';
            setTimeout(() => {
                const close = () => { el.remove(); document.removeEventListener('click', close); };
                document.addEventListener('click', close);
            }, 0);
        }

        function showCardPalette(e, id) {
            showPalette(e.target.closest('button'), (c) => {
                const n = notes.find(x => x.id === id);
                if(n) { n.color = c; renderNotes(); }
            });
        }
        function showCardMenu(e, id) {
            const n = notes.find(x => x.id === id);
            showMenu(e.target.closest('button'), [
                { text: '라벨 추가', action: () => {
                    const l = prompt("라벨 추가:");
                    if(l && !n.labels.includes(l)) { n.labels.push(l); renderNotes(); }
                }}
            ]);
        }

        // --- 7. Modal Logic ---
        let editId = null;
        function openEditModal(n) {
            editId = n.id;
            document.getElementById('modal-title').value = n.title;
            document.getElementById('modal-content').value = n.content;
            document.getElementById('modal-card').style.backgroundColor = n.color;
            const imgEl = document.getElementById('modal-img');
            if(n.image) { imgEl.src = n.image; imgEl.style.display='block'; }
            else { imgEl.style.display='none'; }
            document.getElementById('edit-modal').classList.add('open');
        }
        
        document.getElementById('modal-close-btn').onclick = closeEditModal;
        document.getElementById('edit-modal').onclick = (e) => { if(e.target === document.getElementById('edit-modal')) closeEditModal(); };

        function closeEditModal() {
            if(editId) {
                const n = notes.find(x => x.id === editId);
                const t = document.getElementById('modal-title').value;
                const c = document.getElementById('modal-content').value;
                if(n.title !== t || n.content !== c) {
                    n.title = t; n.content = c;
                    n.updated_at = new Date().toLocaleString();
                    renderNotes();
                }
            }
            document.getElementById('edit-modal').classList.remove('open');
            editId = null;
        }

        // Start App
        initData();
    </script>
</body>
</html>
